/**
 * Module to add a shipping rates calculator to cart page.
 *
 * Copyright (c) 2011-2012 Caroline Schnapp (11heavens.com)
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 */
if (typeof Countries === "object") {
	Countries.updateProvinceLabel = function(e, t) {
		if (typeof e === "string" && Countries[e] && Countries[e].provinces) {
			if (typeof t !== "object") {
				t = document.getElementById("address_province_label");
				if (t === null) {
					return
				}
			}
			t.innerHTML = Countries[e].label;
			var n = jQuery(t).parent();
			var r = n.find("select");
			n.find(".custom-style-select-box-inner").html(Countries[e].provinces[0])
		}
	}
}
if (typeof Shopify.Cart === "undefined") {
	Shopify.Cart = {}
}
Shopify.Cart.ShippingCalculator = function() {
		var _config = {
			submitButton: "Calculate shipping",
			submitButtonDisabled: "Calculating...",
			templateId: "shipping-calculator-response-template",
			wrapperId: "wrapper-response",
			customerIsLoggedIn: false,
			moneyFormat: "$ {{amount}}"
		};
		var _render = function(e) {
			var t = jQuery("#" + _config.templateId);
			var n = jQuery("#" + _config.wrapperId);
			if (t.length && n.length) {
				t.tmpl(e).appendTo(n);
				if (typeof Currency !== "undefined" && typeof Currency.convertAll === "function") {
					var r = "";
					if (jQuery("[name=currencies]").size()) {
						r = jQuery("[name=currencies]").val()
					} else {
						if (jQuery("#currencies span.selected").size()) {
							r = jQuery("#currencies span.selected").attr("data-currency")
						}
					}
					if (r !== "") {
						Currency.convertAll(shopCurrency, r, "#wrapper-response span.money, #estimated-shipping em span.money")
					}
				}
			}
		};
		var _enableButtons = function() {
			jQuery(".get-rates").removeAttr("disabled").removeClass("disabled").val(_config.submitButton)
		};
		var _disableButtons = function() {
			jQuery(".get-rates").val(_config.submitButtonDisabled).attr("disabled", "disabled").addClass("disabled")
		};
		var _getCartShippingRatesForDestination = function(e) {
			var t = {
				type: "GET",
				url: "/cart/shipping_rates.json",
				data: jQuery.param({
					shipping_address: e
				}),
				dataType: "json",
				success: function(t) {
					rates = t.shipping_rates;
					_onCartShippingRatesUpdate(rates, e)
				},
				error: function(e, t) {
					_onError(e, t)
				}
			};
			jQuery.ajax(t)
		};
		var _fullMessagesFromErrors = function(e) {
			var t = [];
			jQuery.each(e, function(e, n) {
				jQuery.each(n, function(n, r) {
					t.push(e + " " + r)
				})
			});
			return t
		};
		var _onError = function(XMLHttpRequest, textStatus) {
			jQuery("#estimated-shipping").hide();
			jQuery("#estimated-shipping em").empty();
			_enableButtons();
			var feedback = "";
			if (XMLHttpRequest.responseText != "") {
				var data = eval("(" + XMLHttpRequest.responseText + ")");
				if (!!data.message) {
					feedback = data.message + "(" + data.status + "): " + data.description
				} else {
					feedback = "Error : " + _fullMessagesFromErrors(data).join("; ")
				}
				if (feedback === "Error : country is not supported.") {
					feedback = "We do not ship to this destination."
				}
			} else {
				feedback = "Error : Code is invalid"
			}
			_render({
				rates: [],
				errorFeedback: feedback,
				success: false
			});
			jQuery("#" + _config.wrapperId).show()
		};
		var _onCartShippingRatesUpdate = function(e, t) {
			_enableButtons();
			var n = "";
			if (t.zip) {
				n += t.zip + ", "
			}
			if (t.province) {
				n += t.province + ", "
			}
			n += t.country;
			if (e.length) {
				if (e[0].price == "0.00") {
					jQuery("#estimated-shipping em").html("FREE")
				} else {
					jQuery("#estimated-shipping em").html(_formatRate(e[0].price))
				}
			}
			_render({
				rates: e,
				address: n,
				success: true
			});
			jQuery("#" + _config.wrapperId + ", #estimated-shipping").fadeIn()
		};
		var _formatRate = function(e) {
			function i(e) {
				return e.replace(/(\d+)(\d{3}[\.,]?)/, "$1,$2")
			}

			function s(e, t) {
				var n = e.toFixed(t).toString();
				if (n.match(/^\.\d+/)) {
					return "0" + n
				} else {
					return n
				}
			}
			if (typeof e == "string") {
				e = e.replace(".", "")
			}
			var t = "";
			var n = /\{\{\s*(\w+)\s*\}\}/;
			var r = _config.moneyFormat;
			switch (r.match(n)[1]) {
				case "amount":
					t = i(s(e / 100, 2));
					break;
				case "amount_no_decimals":
					t = i(s(e / 100, 0));
					break;
				case "amount_with_comma_separator":
					t = s(e / 100, 2).replace(/\./, ",");
					break;
				case "amount_no_decimals_with_comma_separator":
					t = i(s(e / 100, 0)).replace(/\./, ",");
					break
			}
			return r.replace(n, t)
		};
		_init = function() {
			new Shopify.CountryProvinceSelector("address_country", "address_province", {
				hideElement: "address_province_container"
			});
			var e = jQuery("#address_country");
			var t = jQuery("#address_province_label").get(0);
			if (typeof Countries !== "undefined") {
				Countries.updateProvinceLabel(e.val(), t);
				e.change(function() {
					Countries.updateProvinceLabel(e.val(), t)
				})
			}
			jQuery(".get-rates").click(function(e) {
				e.preventDefault();
				_disableButtons();
				jQuery("#" + _config.wrapperId).empty().hide();
				var t = {};
				t.zip = jQuery("#address_zip").val() || "";
				t.country = jQuery("#address_country").val() || "";
				t.province = jQuery("#address_province").val() || "";
				_getCartShippingRatesForDestination(t)
			});
			if (_config.customerIsLoggedIn) {
				jQuery(".get-rates:eq(0)").trigger("click")
			}
		};
		return {
			show: function(e) {
				e = e || {};
				jQuery.extend(_config, e);
				jQuery(function() {
					_init()
				})
			},
			getConfig: function() {
				return _config
			},
			formatRate: function(e) {
				return _formatRate(e)
			}
		}
	}()
	(function(e) {
		if (!e(".header-mobile").is(":visible")) {
			e(document).on("click touchstart", function(n) {
				var i = e("#dropdown-cart");
				var s = e("#cartToggle");
				if (!r.is(n.target) && r.has(n.target).length === 0 && !i.is(n.target) && i.has(n.target).length === 0 && !s.is(n.target) && s.has(n.target).length === 0 && !o.is(n.target) && o.has(n.target).length === 0 && !u.is(n.target) && u.has(n.target).length === 0) {
					t.closeQuickViewPopup();
					t.closeDropdownCart();
					t.closeEmailModalWindow();
					t.closeDropdownSearch()
				}
			})
		}
		e(document).keyup(function(n) {
			if (n.keyCode == 27) {
				t.closeQuickViewPopup();
				t.closeDropdownCart();
				t.closeDropdownSearch();
				clearTimeout(t.Timeout);
				if (e(".modal").is(":visible")) {
					e(".modal").fadeOut(500)
				}
			}
		});
		var t = {
			Timeout: null,
			isSidebarAjaxClick: false,
			init: function() {
				this.initResizeImage();
				this.initMobileMenu();
				this.initSidebar();
				this.initMobileSidebar();
				this.initScrollTop();
				this.initQuickView();
				this.initCloudzoom();
				this.initProductMoreview();
				this.initAddToCart();
				this.initModal();
				this.initProductAddToCart();
				this.initDropDownCart();
				this.initDropdownSearch();
				this.initToggleCollectionPanel();
				this.initWishlist();
				this.initProductWishlist();
				this.initRemoveWishlist();
				this.initInfiniteScrolling()
			},
			checkItemsInDropdownCart: function() {
				if (e("#dropdown-cart .mini-products-list").children().length > 0) {
					e("#dropdown-cart .no-items").hide();
					e("#dropdown-cart .has-items").show()
				} else {
					e("#dropdown-cart .has-items").hide();
					e("#dropdown-cart .no-items").show()
				}
			},
			initModal: function() {
				e(".continue-shopping").click(function() {
					clearTimeout(t.Timeout);
					e(".ajax-success-modal").fadeOut(500)
				});
				e(".close-modal, .overlay").click(function() {
					clearTimeout(t.Timeout);
					e(".ajax-success-modal").fadeOut(500)
				})
			},
			initDropDownCart: function() {
				if (window.dropdowncart_type == "click") {
					e("#cartToggle").click(function() {
						if (e("#dropdown-cart").is(":visible")) {
							e("#dropdown-cart").slideUp("fast")
						} else {
							e("#dropdown-cart").slideDown("fast")
						}
					})
				} else {
					if (!("ontouchstart" in document)) {
						e("#cartToggle").hover(function() {
							if (!e("#dropdown-cart").is(":visible")) {
								e("#dropdown-cart").slideDown("fast")
							}
						});
						e(".wrapper-top-cart").mouseleave(function() {
							e("#dropdown-cart").slideUp("fast")
						})
					} else {
						e("#cartToggle").click(function() {
							if (e("#dropdown-cart").is(":visible")) {
								e("#dropdown-cart").slideUp("fast")
							} else {
								e("#dropdown-cart").slideDown("fast")
							}
						})
					}
				}
				t.checkItemsInDropdownCart();
				e("#dropdown-cart .no-items a").click(function() {
					e("#dropdown-cart").slideUp("fast")
				});
				e("#dropdown-cart .btn-remove").click(function(n) {
					n.preventDefault();
					var r = e(this).parents(".item").attr("id");
					r = r.match(/\d+/g);
					Shopify.removeItem(r, function(e) {
						t.doUpdateDropdownCart(e)
					})
				})
			},
			closeDropdownCart: function() {
				if (e("#dropdown-cart").is(":visible")) {
					e("#dropdown-cart").slideUp("fast")
				}
			},
			initProductAddToCart: function() {
				if (e("#product-add-to-cart").length > 0) {
					e("#product-add-to-cart").click(function(n) {
						n.preventDefault();
						if (e(this).attr("disabled") != "disabled") {
							if (!window.ajax_cart) {
								e(this).closest("form").submit()
							} else {
								var r = e("#add-to-cart-form select[name=id]").val();
								if (!r) {
									r = e("#add-to-cart-form input[name=id]").val()
								}
								var i = e("#add-to-cart-form input[name=quantity]").val();
								if (!i) {
									i = 1
								}
								var s = e(".product-title h2").text();
								var o = e("#product-featured-image").attr("src");
								t.doAjaxAddToCart(r, i, s, o)
							}
						}
						return false
					})
				}
			},
			initAddToCart: function() {
				if (e(".add-to-cart-btn").length > 0) {
					e(".add-to-cart-btn").click(function(n) {
						n.preventDefault();
						if (e(this).attr("disabled") != "disabled") {
							var r = e(this).parents(".product-item");
							var i = e(r).attr("id");
							i = i.match(/\d+/g);
							if (!window.ajax_cart) {
								e("#product-actions-" + i).submit()
							} else {
								var s = e("#product-actions-" + i + " select[name=id]").val();
								if (!s) {
									s = e("#product-actions-" + i + " input[name=id]").val()
								}
								var o = e("#product-actions-" + i + " input[name=quantity]").val();
								if (!o) {
									o = 1
								}
								var u = e(r).find(".product-title").text();
								var a = e(r).find(".product-grid-image img").attr("src");
								t.doAjaxAddToCart(s, o, u, a)
							}
						}
						return false
					})
				}
			}
		}
	})(jQuery)